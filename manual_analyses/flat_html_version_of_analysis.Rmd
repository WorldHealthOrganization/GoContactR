---
title: "Manual Run of Guinea Analyses"
output:
  rmarkdown::html_document:
    theme: cerulean
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
```

```{css}

h1 {
  text-align: center;
}


body {
  background-color: #f0f2fa
}


.tab-content{
    margin-bottom: 70px;
}
```

```{r setupPackages, include=FALSE, results="hide"}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~  Packages ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
library(here)
library(paletteer)
library(highcharter)
library(shiny)
library(shinyjs)
library(shinyWidgets)
library(shinydashboard)
library(shinydashboardPlus)
library(shinycssloaders)
library(fresh)
library(reactable)
library(reactablefmtr)

library(lubridate)
library(reactable)
library(inspectdf)
library(waiter)
library(visdat)
library(here)
library(stringi)
library(anytime)
library(glue)
library(janitor)
library(scales)

library(tidyverse)


options(scipen=999) # turn off scientific notation

set.seed(1) # fix seed

options(tibble.print_max = 30, tibble.print_min = 30)

space_cadet <- "#1C2541"
burnt_sienna <- "#EE6C4D"
languid_lavender <- "#E8D7F1"
ghost_white <- "#f0f2fa"
magnolia <- "#faf5fc"
beau_blue <- "#CFE9FF"
bittersweet <- "#F07167"
white <- "#FFFFFF"
alice_blue <- "#D9F0FE"
who_blue <- "#158BC6"
light_gray <- "#ebebeb"
russian_violet <- "#332859"
cinnabar <- "#E64B35"
coral <- "#ff7a4a"

col2hex <- function(col, alpha) rgb(t(col2rgb(col)), alpha=alpha, maxColorValue=255)


ViewExcel <-
  function(df = .Last.value,
           file = tempfile(fileext = ".csv")) {
    df <- try(as.data.frame(df))
    stopifnot(is.data.frame(df))
    utils::write.csv(df, file = file)
    
    shell.exec  <- function(x)
    {
      # replacement for shell.exe (doesn't exist on MAC)
      if (exists("shell.exec", where = "package:base"))
        return(base::shell.exec(x))
      comm <- paste("open", x)
      return(system(comm))
    }
    
    
    shell.exec(file)
  }

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~~ highcharter theme ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

options(highcharter.theme = hc_theme_hcrt())


myMenuItems <- c("printChart", "separator", "downloadPNG", "downloadJPEG", "downloadPDF", "downloadSVG", "separator", "downloadCSV", "downloadXLS")

newtheme <- hc_theme_merge(
  getOption("highcharter.theme"), 
  hc_theme(chart = list(backgroundColor = "white", 
                        zoomType= "xy",
                        panning = list(enabled = TRUE, type = "xy"),
                        panKey = "shift"), 
           colors = c("#332859",(paletteer_d("ggsci::nrc_npg") %>% as.character() %>% str_sub(1,7))),
           exporting = list(buttons = list(contextButton = list(menuItems = myMenuItems))),
           legend = list(enabled = TRUE
                         #, 
                         #align = "right", 
                         #layout = "proximate" 
                         )
           )
)
options(highcharter.theme = newtheme)






#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~~ ggplot2 theme ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

my_theme <- theme_classic() + 
  theme(
    plot.title = element_text(face = "bold"),
    #plot.background = element_rect(fill = "gray93"),
    panel.grid.major = element_line(color = "gray95", size = 0.2),
    strip.background = element_blank(),
    # element textbox is from ggtext
    strip.text = ggtext::element_textbox(
      size = 11, face = "bold",
      color = "white", fill = "steelblue3", halign = 0.5, 
      r = unit(5, "pt"), width = unit(1, "npc"),
      padding = margin(2, 0, 1, 0), margin = margin(3, 3, 3, 3)
    )
  )

theme_set(my_theme)

```

```{r loadData, include=FALSE, results="hide"}
todays_date <- as.Date("2021-03-01")
#todays_date <- as.Date(Sys.Date())


contacts_df_raw <- 
  readxl::read_excel(here("data/Base contacts_GUINEE_2021_03_14_GLOBAL.xlsx"))  %>% 
  clean_names() %>% 
  type_convert()
  
  
cleaning_rules <- rio::import(here("data", "cleaning_rules_contacts.xlsx"))



# data in
contacts_df <-
  contacts_df_raw %>%
  # clean vaccination column, type_de_contact, unite_age, prefecture, lien_avec_las_cas. 
  # No etat_suivi column to clean yet because I have not created it
  linelist::clean_variable_spelling(cleaning_rules) %>%
  # add counter column. 1 for all records
  mutate(counter = 1) %>%
  # row numbers to match Excel spreadsheet
  mutate(row_id = row_number() + 3) %>%
  # convert dates to dates
  mutate(across(.cols = matches("date_"),
                .fns = ~ as.Date(.x))) %>%
  # rename the follow_up_day columns
  rename_with(.cols = paste0("j", 1:21),
              .fn = ~ paste("follow_up_day", str_remove_all(.x, "j"), sep = "_")) %>%
  # duplicate the follow_up_day columns, change name to follow_up_date
  mutate(across(.cols = paste("follow_up_day", 1:21, sep = "_"),
                .fns = ~ .,
                .names = "follow_up_date_{str_remove_all(.col, 'follow_up_day_')}")) %>%
  # now, we convert the numbers in the follow up day columns
  # to reflect the nth day of follow up
  mutate(across(.cols = starts_with("follow_up_date_"),
                .fn = ~ str_extract(cur_column(), paste(21:1, collapse = "|")) %>% as.numeric() )) %>% # start from 21 otherwise you'll remove the tens unit before you get to the teens
  # clean vaccination column
  mutate(across(vaccination,
                ~ .x %>%
                  stri_trans_general("Latin-ASCII") %>%
                  str_to_lower() %>%
                  str_to_sentence())) %>%
  # clean admin levels
  mutate(across(prefecture, 
                ~ .x %>%
                  str_to_sentence()))


pivot_day <- 
  contacts_df %>% 
  select(row_id, paste0("follow_up_day_", 1:21)) %>% 
  pivot_longer(cols = c(paste0("follow_up_day_", 1:21)), 
               names_to = "follow_up_day", 
               values_to = "etat_suivi") %>% 
  # clean "etat de suivi" column
  linelist::clean_variable_spelling(wordlists = cleaning_rules)


legend_df <- 
  tribble(    
    ~breaks ,                  ~colors,                   
    "Non vu",                  col2hex("orangered"),                  
    "Vu",                      col2hex("lightseagreen"),  
    "Cas confirmé",            col2hex("purple3"),     
    "Cas suspect",             col2hex("yellow"),       
    "Manquant",                col2hex("pink4"),          
    "Deplacé",                 col2hex("wheat3"),  
    "Recyclé",                 col2hex("yellow4"),          
    "Fin de suivi",            col2hex("dodgerblue3"),    
    "Suivi futur",             col2hex("goldenrod"),      
    "Données manquantes",      col2hex("black"),          
    "Doublon",                 col2hex("slategray3"),          
  ) %>% 
  arrange(breaks) %>% 
  mutate(breaks = fct_inorder(breaks)) %>% 
  mutate(legend_index = row_number())


contacts_df_long <- 
 contacts_df %>%
  # slice_sample(n = 50) %>%
  inner_join(pivot_day, by = "row_id") %>%
  # paste the day of followup
  mutate(follow_up_day = str_extract(follow_up_day, paste(21:1, collapse = "|"))) %>%
  mutate(follow_up_day = as.numeric(follow_up_day)) %>%
  # assume that follow up begins from date of last interaction
  mutate(follow_up_date = follow_up_day + date_du_dernier_contact) %>%
  mutate(etat_suivi = as.character(etat_suivi)) %>%
  # change status of records that should be still active
  mutate(etat_suivi = if_else(follow_up_date > todays_date,
                                           "Suivi futur",
                                           etat_suivi
  )) %>%
  mutate(etat_suivi = replace_na(etat_suivi, "Données manquantes")) %>% 
  # - if follow-up lasted the full 21 days,
  # - change last follow_up state to "Fin de suivi"
  mutate(etat_suivi = if_else(follow_up_day == 21 & etat_suivi == "Vu",
                                           "Fin de suivi",
                                           etat_suivi)) %>% 
  # add legend colors
  left_join(legend_df, by = c("etat_suivi" = "breaks")) %>% 
  # drop records that should not exist based on faux date
  group_by(row_id) %>% 
  filter(min(follow_up_date) <= todays_date) %>%
  ungroup() %>% 
  # change records to "Suivi Futur" if ahead of today's date
  mutate(etat_suivi = if_else(follow_up_date > todays_date,
                                           "Suivi futur",
                                           etat_suivi
  ))  %>% 
  mutate(etat_suivi_simple = etat_suivi) %>% 
  mutate(etat_suivi_simple = recode(etat_suivi_simple,
                                    "Vu" = "Vu",
                                    "Non vu" = "Non vu",
                                    "Cas suspect" = "Vu",
                                    "Decedé" = "Vu",
                                    "Deplacé" = "Non vu",
                                    "Cas confirmé" = "Vu",
                                    "Transferé" = "Vu",
                                    "Refus" = "Non vu",
                                    "Reco. pas passé" = "Non vu",
                                    "Doublon" = "Doublon",
                                    "Recyclé" = "Vu", 
                                    "Fin de suivi" = "Vu", 
                                    "Données manquantes" = "Non vu"
                                    )
  )

  

```

For plots below, we assume the date is `r todays_date` (in order to see what it would look like to have active cases).

<br> <br> <br>

# All contacts (since the beginning of the epidemic)

## Table and sunburst plot of all contacts by region {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Number of total contacts per prefecture and sous-prefecture ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <- 
  contacts_df_long %>%
  group_by(row_id) %>% 
  # slice long frame
  slice_head() %>% 
  ungroup() %>% 
  select(prefecture, sous_prefecture) %>%
  count(prefecture, sous_prefecture) %>%
  group_by(prefecture, sous_prefecture) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>% 
  mutate(percent = round(100 * n/sum(n), 2)) %>% 
  group_by(prefecture) %>%
  mutate(prefecture_sum = sum(n)) %>% 
  ungroup() %>% 
  mutate(prefecture_percent = prefecture_sum/sum(n)) %>% 
  ungroup() %>% 
  arrange(-prefecture_percent) %>% 
  select(Prefecture = prefecture, 
         `Sous-prefecture` = sous_prefecture, 
         `Total contacts` = n,
         `%` = percent)


```

### Table

```{r}
data_to_plot %>%
  reactable(columns = list(`Total contacts` = colDef(cell = data_bars_gradient(data_to_plot, 
                                                                             colors = c(languid_lavender, russian_violet),
                                                                              background = "transparent"),
                                                   style = list(fontFamily = "Courier", whiteSpace = "pre", fontSize = 13)), 
                           Prefecture = colDef(style = JS("function(rowInfo, colInfo, state) {
                                                          var firstSorted = state.sorted[0]
                                                          // Merge cells if unsorted or sorting by Prefecture
                                                          if (!firstSorted || firstSorted.id === 'Prefecture') {
                                                          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
                                                          if (prevRow && rowInfo.row['Prefecture'] === prevRow['Prefecture']) {
                                                          return { visibility: 'hidden' }
                                                          }
                                                          }}"))),
                striped = TRUE,
                highlight = TRUE,
                theme = reactableTheme(stripedColor = "#f0f1fc",
                                       highlightColor = "#DADEFB",
                                       cellPadding = "8px 12px",
                                       style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif")
                ),
            defaultPageSize = 15)
```

### Sunburst plot

```{r}
contact_regions <-
  contacts_df_long %>%
  group_by(row_id) %>% 
  # slice long frame
  slice_head() %>% 
  ungroup() %>%
  select(prefecture, sous_prefecture, quartier) %>%
  mutate(across(
    .fns =
      ~ .x %>%
        str_to_lower() %>%
        str_to_title() %>%
        replace_na("NA") %>%
        str_trim()
  )) %>%
  add_count(prefecture, name = "n_prefecture") %>%
  mutate(pct_prefecture = round(100 * n_prefecture / nrow(.), 
                                    digits = 2)) %>%
  mutate(prefecture = paste0(prefecture, 
                                 " (", pct_prefecture, "%", ")")) %>%
  group_by(prefecture) %>%
  mutate(sous_prefecture = fct_lump(other_level = "Autres", 
                                   sous_prefecture, prop = 0.01)) %>%
  add_count(sous_prefecture, name = "n_sous_prefecture") %>%
  mutate(pct_sous_prefecture = round(100 * n_sous_prefecture / nrow(.), 
                                    digits = 2)) %>%
  mutate(sous_prefecture = paste0(sous_prefecture, " (", pct_sous_prefecture, "%", ")")) %>%
  group_by(prefecture, sous_prefecture) %>%
  mutate(quartier = fct_lump(other_level = "Autres", quartier, prop = 0.02)) %>%
  add_count(quartier, name = "n_quartier") %>%
  mutate(pct_quartier = round(100 * n_quartier / nrow(.), digits = 2)) %>%
  mutate(quartier = paste0(quartier, " (", pct_quartier, "%", ")")) %>%
  group_by(prefecture, sous_prefecture, quartier) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  arrange(-n_prefecture)
  
  full_palette <- 
    c(russian_violet, cinnabar,
      "#56bfa3", "#f79f57" ,"#7570B3","#56B4E9", #greenblue #lightorange #purplepastel #lightblue
      "#3758a6" , "#CC79A7" , "#91142c", "#63a88a", #darkblue #pinkpurple #wine #pastelgreen
      "#a3b0c4", "#870476", "#479444", "#3cd6d6" ) # grey, # royalpurple #darkgreen # cyan 

  color_df <- 
    data.frame(prefecture = unique(contact_regions$prefecture)) %>% 
    add_column(color_lvl_1 = full_palette[1:nrow(.)])
  
  contact_regions_list <- 
    contact_regions %>% 
    data_to_hierarchical(group_vars = c(prefecture, 
                                        sous_prefecture, 
                                        quartier
    ), 
    size_var = n_quartier, 
    colors= color_df$color_lvl_1)
  
  
  x <- c("Type: ", "n = ")
  y <- c("{point.name}", "{point.value}")
  tltip <- tooltip_table(x, y)
  
  
  highchart() %>% 
    hc_chart(type = "sunburst") %>% 
    hc_title(text = "Breakdown of contacts by Region ") %>% 
    #hc_subtitle(text = subtitle, useHTML = TRUE) %>% 
    hc_add_series(data = contact_regions_list,
                  allowDrillToNode = TRUE,
                  levelIsConstant = FALSE,
                  #textOverflow = "clip",
                  levels = list(list(level = 1,
                                     borderWidth = 1, 
                                     dataLabels = list(enabled = TRUE,
                                                       color = "#FFFFFF",
                                                       style = list(fontSize = "14px",
                                                                    #fontWeight = "bold",
                                                                    #textOutline = "white", 
                                                                    opacity = 0.8))), 
                                list(level = 2, 
                                     borderWidth = 0,
                                     dataLabels = list(enabled = TRUE, 
                                                       color = "#FFFFFF",
                                                       style = list(fontSize = "12px", 
                                                                    textOutline = FALSE, 
                                                                    opacity = 0.8))), 
                                list(level = 3,
                                     borderWidth = 0,
                                     dataLabels = list(enabled = TRUE, 
                                                       color = "#FFFFFF",
                                                       style = list(fontSize = "8px", 
                                                                    textOutline = FALSE, 
                                                                    opacity = 0.8))))) %>% 
    hc_plotOptions(sunburst = list(dataLabels = list(enabled = TRUE) )) %>% 
    hc_size(600, 600) %>% 
    hc_tooltip(useHTML = TRUE, 
               headerFormat = "", pointFormat = tltip) 
```


## Table and snake plot of all contacts for each day of follow-up {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~  Individual timeline ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

number_to_sample <- 100

data_to_plot <-
  contacts_df_long %>%
  group_by(row_id) %>%
  filter(row_id %in% sample(unique(.$row_id), number_to_sample, replace = F)) %>%
  filter(follow_up_date < todays_date) %>%
  mutate(hc_ttip = glue("<b>ID: </b> {id_contact} 
                         <b>Prefecture: </b> {prefecture}
                         <b>Sous-prefecture: </b> {sous_prefecture}
                         <b>Date: </b> {format.Date(follow_up_date, format = '%b %d')} (Jour de suivi {follow_up_day}) 
                         <b>Status:</b> {etat_suivi}
                         ")) %>%
  ungroup() %>%
  arrange(etat_suivi) %>%   # arranging is necessary so that that colors are pulled in the right order for highcharter
  mutate(follow_up_date_timestamp = datetime_to_timestamp(follow_up_date))
```

### Table

```{r}
data_to_tabulate %>% 
  select(ID = id_contact, 
         Date = follow_up_date, 
         `Follow-up State` = etat_suivi) %>% 
  group_by(ID) %>% 
  arrange(desc(Date)) %>% 
  ungroup() %>% 
reactable(groupBy = "ID", columns = list(
  `Follow-up State` = colDef(aggregate = "frequency")
))
```

### Snake plot

Snake plot is sampled to increase plotting speed

```{r}
data_to_plot %>%
  hchart("scatter",
                hcaes(x = follow_up_date, y = row_id,
                      color = colors, group = etat_suivi)) %>%
  hc_colors(unique(data_to_plot$colors)) %>%
  hc_plotOptions(series = list(marker = list(radius = 3,
                                             symbol = "circle"))) %>%
  hc_xAxis(title = list(text = "Date"),
             min = min(data_to_plot$follow_up_date, na.rm = T)  %>% datetime_to_timestamp(),
             max = max(data_to_plot$follow_up_date, na.rm = T) %>% datetime_to_timestamp()
             ) %>%
  hc_yAxis(title = list(text = "Contact ID"),
             min = min(data_to_plot$n, na.rm = T),
             max = max(data_to_plot$n, na.rm = T)) %>%
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>%
  hc_plotOptions(scatter = list(stickyTracking = F)) %>%
  hc_exporting(enabled = TRUE)
```

## Table and bar chart for active contacts for each day of follow-up {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Stacked bar chart ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <-
  contacts_df_long %>%
  group_by(follow_up_date) %>%
  count(etat_suivi) %>%
  ungroup() %>%
  complete(follow_up_date, etat_suivi, fill = list(n = 0)) %>%
  # replace 0s with NA for Upcoming follow ups before today's date
  # and replace 0s with NA for past follow ups after today's date
  mutate(n = ifelse(etat_suivi == "Suivi futur" &
                      follow_up_date <= todays_date,
                    NA_integer_,
                    n)) %>%
  mutate(prop = n/sum(n)) %>%
  mutate(hc_ttip = glue("<b>Date:</b> {format.Date(follow_up_date,  format = '%a %b %d, \\'%y')}
                        <b>{etat_suivi}:</b> {n}
                        ")) %>%
  left_join(legend_df, by = c("etat_suivi" = "breaks")) %>%
  arrange(etat_suivi) # arranging is necessary so that that colors are pulled in the right order for highcharter
```

### Table

```{r}
data_to_plot %>% 
  select(1:3) %>% 
  pivot_wider(names_from = etat_suivi, values_from = n) %>% 
  select(Date = follow_up_date, Vu, `Non vu`, `Fin de suivi`, `Cas confirmé`, `Suivi futur`) %>% 
  reactable()
```

<br> <br> <br>

### Bar chart

```{r}
data_to_plot %>%
  hchart("column", hcaes(x = follow_up_date, y = n,
                       color = colors,
                       group = etat_suivi),
           fillOpacity = 0.35) %>%
  hc_colors(unique(data_to_plot$colors)) %>%
  hc_plotOptions(column = list(series = list(fillOpacity = 0.1),
                                   marker = list(enabled = TRUE,
                                                 radius = 3,
                                                 symbol = "circle"),
                                   states = list(inactive = list(opacity = 0.1)),
                                   stacking = "normal")) %>%
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>%
  hc_xAxis(title = list(text = "Date")) %>%
  hc_yAxis(title = list(text = "Number of contacts"))


```

<br> <br> <br>

# Active contacts

## Table and donut plot of active contacts per case {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Number of active contacts per case  ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <- 
  contacts_df_long %>%
  group_by(row_id) %>% 
  # drop inactive cases
  filter(max(follow_up_date) >= todays_date) %>% 
  # slice long frame
  slice_head() %>% 
  # count cases per id
  group_by(id) %>% 
  count() %>% 
  arrange(-n) %>% 
  select(`Case ID` = id, 
         `Number of active contacts` = n
         ) %>% 
  ungroup()
```

### Table

```{r}
data_to_plot %>%
  reactable(columns = list(`Number of active contacts` = colDef(cell = data_bars_gradient(data_to_plot, 
                                                                             colors = c(languid_lavender, russian_violet )),
                                                   style = list(fontFamily = "Courier", whiteSpace = "pre", fontSize = 13))), 
            defaultPageSize = 15)
```

### Donut plot

```{r}
data_to_plot %>%
  mutate(`Case ID` = fct_lump(`Case ID`, prop = 0.05, w = `Number of active contacts` )) %>% 
  group_by(`Case ID`) %>% 
  mutate(`Number of active contacts` = sum(`Number of active contacts`) ) %>% 
  slice_head() %>% 
  ungroup() %>% 
  hchart("pie", hcaes(name = `Case ID` , y = `Number of active contacts` ),
         innerSize = "40%",
         showInLegend = TRUE,
         dataLabels = list(enabled = TRUE,
                           style = list(fontSize = 12),
                           format = '{point.name}: {point.y}, ({point.percentage:.1f} %)'))  %>%
  hc_title(text= 'Case ID')



```

## Table and donut plot of active contacts by link with the case {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Number of active contacts by contact type  ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <- 
  contacts_df_long %>%
  group_by(row_id) %>% 
  # drop inactive cases
  filter(max(follow_up_date) >= todays_date) %>% 
  # slice long frame
  slice_head() %>% 
  ungroup() %>% 
  # count cases per id
  group_by(lien_avec_le_cas) %>% 
  count() %>% 
  arrange(-n) %>% 
  select(`Link with the case` = lien_avec_le_cas, 
         `Number of active contacts` = n
         )
```

### Table

```{r}
data_to_plot %>% 
  reactable(columns = list(`Number of active contacts` = colDef(cell = data_bars_gradient(data_to_plot, 
                                                                             colors = c(languid_lavender, russian_violet )),
                                                   style = list(fontFamily = "Courier", whiteSpace = "pre", fontSize = 13))), 
            defaultPageSize = 15
            )
```

### Donut plot

```{r}
data_to_plot %>%
  hchart("pie", hcaes(name = `Link with the case`, y = `Number of active contacts` ),
         innerSize = "40%",
         showInLegend = TRUE,
         dataLabels = list(enabled = TRUE,
                           style = list(fontSize = 16),
                           format = '{point.name}: {point.y}, ({point.percentage:.1f} %)'))  %>%
  hc_title(text= 'Link with the case')
```




## Table and snake plot of active contacts for each day of follow-up {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Snake plot for active contacts ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

number_to_sample <- 100

data_to_plot <-
  contacts_df_long %>%
  group_by(row_id) %>% 
  # sample
  filter(row_id %in% sample(unique(.$row_id), number_to_sample, replace = F)) %>% 
  # drop inactive cases
  filter(max(follow_up_date) >= todays_date) %>% 
  mutate(hc_ttip = glue("<b>ID: </b> {id_contact} 
                         <b>Prefecture: </b> {prefecture}
                         <b>Sous-prefecture: </b> {sous_prefecture}
                         <b>Date: </b> {format.Date(follow_up_date, format = '%b %d')} (Jour de suivi {follow_up_day}) 
                         <b>Status:</b> {etat_suivi}
                         ")) %>% 
  ungroup() %>% 
  arrange(etat_suivi) %>%   # arranging is necessary so that that colors are pulled in the right order for highcharter
  mutate(follow_up_date_timestamp = datetime_to_timestamp(follow_up_date))

data_to_tabulate <- 
  data_to_plot %>% 
  select(id_contact, follow_up_date, etat_suivi)
```

### Table

```{r}
data_to_tabulate %>% 
  select(ID = id_contact, 
         Date = follow_up_date, 
         `Follow-up State` = etat_suivi) %>% 
  group_by(ID) %>% 
  arrange(desc(Date)) %>% 
  ungroup() %>% 
reactable(groupBy = "ID", columns = list(
  `Follow-up State` = colDef(aggregate = "frequency")
))
```

### Snake plot

```{r}
data_to_plot %>% 
  hchart("scatter", 
                hcaes(x = follow_up_date, y = row_id, 
                      color = colors, group = etat_suivi)) %>% 
  hc_colors(unique(data_to_plot$colors)) %>% 
  hc_plotOptions(series = list(marker = list(radius = 3, 
                                             symbol = "circle"))) %>% 
  hc_xAxis(title = list(text = "Date"),
             min = min(data_to_plot$follow_up_date, na.rm = T)  %>% datetime_to_timestamp(), 
             max = max(data_to_plot$follow_up_date, na.rm = T) %>% datetime_to_timestamp()
             ) %>% 
  hc_yAxis(title = list(text = "Contact ID"),
             min = min(data_to_plot$n, na.rm = T), 
             max = max(data_to_plot$n, na.rm = T)) %>% 
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>% 
  hc_plotOptions(scatter = list(stickyTracking = F)) %>% 
  hc_exporting(enabled = TRUE)
```


## Table and bar chart for active contacts for each day of follow-up {.tabset}

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Stacked bar chart for active contacts ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


data_to_plot <-
  contacts_df_long %>%
  group_by(row_id) %>% 
  # drop inactive cases
  filter(max(follow_up_date) >= todays_date) %>% 
  group_by(follow_up_date) %>% 
  count(etat_suivi) %>% 
  ungroup() %>% 
  complete(follow_up_date, etat_suivi, fill = list(n = 0)) %>% 
  # replace 0s with NA for Upcoming follow ups before today's date
  # and replace 0s with NA for past follow ups after today's date
  mutate(n = ifelse(etat_suivi == "Suivi futur" & 
                      follow_up_date <= todays_date, 
                    NA_integer_, 
                    n)) %>% 
  mutate(prop = n/sum(n)) %>% 
  mutate(hc_ttip = glue("<b>Date:</b> {format.Date(follow_up_date,  format = '%a %b %d, \\'%y')}
                        <b>{etat_suivi}:</b> {n}
                        ")) %>% 
  left_join(legend_df, by = c("etat_suivi" = "breaks")) %>% 
  arrange(etat_suivi) # arranging is necessary so that that colors are pulled in the right order for highcharter
```

### Table

```{r}
data_to_plot %>% 
  select(1:3) %>% 
  pivot_wider(names_from = etat_suivi, values_from = n) %>% 
  select(Date = follow_up_date, Vu, `Non vu`, `Fin de suivi`, `Cas confirmé`, `Suivi futur`) %>% 
  reactable()
```

<br> <br> <br>

### Bar chart

```{r}
data_to_plot %>% 
  hchart("column", hcaes(x = follow_up_date, y = n, 
                       color = colors,
                       group = etat_suivi), 
           fillOpacity = 0.35) %>% 
  hc_colors(unique(data_to_plot$colors)) %>% 
  hc_plotOptions(column = list(series = list(fillOpacity = 0.1),
                                   marker = list(enabled = TRUE, 
                                                 radius = 3, 
                                                 symbol = "circle"),
                                   states = list(inactive = list(opacity = 0.1)), 
                                   stacking = "normal")) %>% 
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>% 
  hc_xAxis(title = list(text = "Date")) %>% 
  hc_yAxis(title = list(text = "Number of contacts"))

```

<br> <br> <br>

# Follow-up performance

## Stacked bar chart of contacts showing tracing status

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Stacked bar chart ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <- 
  contacts_df_long %>%
  group_by(follow_up_date) %>% 
  count(etat_suivi_simple) %>% 
  ungroup() %>% 
  complete(follow_up_date, etat_suivi_simple, fill = list(n = 0)) %>% 
  # replace 0s with NA for Upcoming follow ups before today's date
  # and replace 0s with NA for past follow ups after today's date
  mutate(n = ifelse(etat_suivi_simple == "Suivi futur" & 
                      follow_up_date <= todays_date, 
                    NA_integer_, 
                    n)) %>% 
  mutate(prop = n/sum(n)) %>% 
  mutate(hc_ttip = glue("<b>Date:</b> {format.Date(follow_up_date,  format = '%a %b %d, %Y')}
                        <b>{etat_suivi_simple}:</b> {n}
                        ")) %>% 
  left_join(legend_df, by = c("etat_suivi_simple" = "breaks")) %>% 
  arrange(etat_suivi_simple)  # arranging is necessary so that that colors are pulled in the right order for highcharter

data_to_plot %>%  
  hchart("column", hcaes(x = follow_up_date, y = n, 
                       color = colors,
                       group = etat_suivi_simple), 
           fillOpacity = 0.35) %>% 
  hc_colors(unique(data_to_plot$colors)) %>% 
  hc_plotOptions(column = list(series = list(fillOpacity = 0.1),
                                   marker = list(enabled = TRUE, 
                                                 radius = 3, 
                                                 symbol = "circle"),
                                   states = list(inactive = list(opacity = 0.1)), 
                                   stacking = "normal")) %>% 
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>% 
  hc_xAxis(title = list(text = "Date")) %>% 
  hc_yAxis(title = list(text = "Number of contacts"))
```

## Percentage of contacts seen

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# ~ Percentage seen ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_to_plot <- 
  contacts_df_long %>%
  filter(etat_suivi_simple != "Suivi futur") %>% 
  group_by(follow_up_date) %>% 
  count(etat_suivi_simple) %>% 
  ungroup() %>% 
  complete(follow_up_date, etat_suivi_simple, fill = list(n = 0)) %>% 
  group_by(follow_up_date) %>% 
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>% 
  mutate(pct = round(100*prop,0)) %>% 
  mutate(pct_paste = percent(prop)) %>% 
  ungroup() %>% 
  filter(etat_suivi_simple == "Vu") %>% 
  mutate(hc_ttip = glue("<b>Date:</b> {format.Date(follow_up_date,  format = '%a %b %d, %Y')}
                        <b>{etat_suivi_simple}:</b> {pct_paste} ({n} of {total} )
                        ")) %>% 
  left_join(legend_df, by = c("etat_suivi_simple" = "breaks")) %>% 
  arrange(etat_suivi_simple)  # arranging is necessary so that that colors are pulled in the right order for highcharter

data_to_plot %>%  
  hchart("line", hcaes(x = follow_up_date, y = pct, color = colors, group = etat_suivi_simple), 
           fillOpacity = 0.35) %>% 
  hc_colors(unique(data_to_plot$colors)) %>% 
  hc_plotOptions(line = list(marker = list(enabled = TRUE,
                                           radius = 3, 
                                           symbol = "circle"),
                             dataLabels = list(enabled = TRUE)
                                   )) %>% 
  hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>% 
  hc_xAxis(title = list(text = "Date")) %>% 
  hc_yAxis(title = list(text = "% de contacts vus"))


```




<!-- ## Follow up detail -->

<!-- National-level plot showing contacts followed up versus contacts not followed up on each day. -->

<!-- The contact tracing team can use this to assess what proportion of inner_join they have successfully reached and are following up with. -->

<!-- As this is a summary figure, the only categories shown are "Followed" and "Not followed" and "Suivi futur". -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   mutate(etat_suivi = recode(etat_suivi,  -->

<!--                                           "Completed" = "Followed", -->

<!--                                           "Developed symptoms" = "Followed", -->

<!--                                           "Has tested negative" = "Followed", -->

<!--                                           "Has tested positive" = "Followed", -->

<!--                                           "Lost to follow-up" = "Not followed", -->

<!--                                        )) %>%  -->

<!--   filter(etat_suivi != "Missing status") %>%  -->

<!--   group_by(follow_up_date) %>%  -->

<!--   count(etat_suivi) %>%  -->

<!--   #filter(etat_suivi %in% c("Followed", "Not followed")) %>%  -->

<!--   ungroup() %>%  -->

<!--   complete(follow_up_date, etat_suivi, fill = list(n = 0)) %>%  -->

<!--   # replace 0s with NA since for Upcoming follow ups before today's date -->

<!--   # and replace 0s with NA for past follow ups after today's date -->

<!--   mutate(n = ifelse(etat_suivi == "Suivi futur" &  -->

<!--                       follow_up_date <= todays_date,  -->

<!--                     NA_integer_,  -->

<!--                     n)) %>%  -->

<!-- #  mutate(n = ifelse(etat_suivi %in% c("Followed", "Not followed") &  -->

<!--  #                     follow_up_date > todays_date,  -->

<!--   #                  NA_integer_,  -->

<!--    #                 n)) %>%  -->

<!--   mutate(prop = n/sum(n)) %>%  -->

<!--   mutate(hc_ttip = glue("{format.Date(follow_up_date,  format = '%a %b %d, \\'%y')} -->

<!--                         <b>Contacts {str_to_lower(etat_suivi)}:</b> {n} -->

<!--                         ")) %>%  -->

<!--   #inner_join(legend_df, by = c("etat_suivi" = "breaks")) %>%  -->

<!--   arrange(etat_suivi)   # arranging is necessary so that that colors are pulled in the right order for highcharter -->

<!-- data_to_plot %>%  -->

<!--   hchart("areaspline", hcaes(x = follow_up_date, y = n,  -->

<!--                        #color = etat_suivi,  -->

<!--                        color = etat_suivi, -->

<!--                        group = etat_suivi),  -->

<!--            fillOpacity = 0.35) %>%  -->

<!--   #hc_colors(unique(data_to_plot$colors)) %>%  -->

<!--   hc_plotOptions(areaspline = list(series = list(fillOpacity = 0.1), -->

<!--                                    marker = list(enabled = TRUE,  -->

<!--                                                  radius = 3,  -->

<!--                                                  symbol = "circle"), -->

<!--                                    states = list(inactive = list(opacity = 0.4)))) %>%  -->

<!--   hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}")) %>%  -->

<!--   hc_xAxis(title = list(text = "Date")) %>%  -->

<!--   hc_yAxis(title = list(text = "Number of contacts")) -->

<!-- ``` -->

<!-- ## Regional plots of follow-up performance over time -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   select( -->

<!--     row_id, -->

<!--     name_last_contact, -->

<!--     name_first_contact, -->

<!--     date_last_interaction, -->

<!--     follow_up_day, -->

<!--     follow_up_date, -->

<!--     etat_suivi,  -->

<!--     prefecture -->

<!--   ) %>%  -->

<!--   mutate(etat_suivi = recode(etat_suivi,  -->

<!--                                           "Completed" = "Followed", -->

<!--                                           "Developed symptoms" = "Followed", -->

<!--                                           "Has tested negative" = "Followed", -->

<!--                                           "Has tested positive" = "Followed", -->

<!--                                           "Lost to follow-up" = "Not followed", -->

<!--                                        )) %>%  -->

<!--   filter(etat_suivi != "Missing status") %>%  -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(etat_suivi) %>%  -->

<!--   #filter(etat_suivi %in% c("Followed", "Not followed")) %>%  -->

<!--   ungroup() %>%  -->

<!--   complete(follow_up_date, prefecture, etat_suivi, fill = list(n = 0)) %>%  -->

<!--   # replace 0s with NA since for Upcoming follow ups before today's date -->

<!--   # and replace 0s with NA for past follow ups after today's date -->

<!--   mutate(n = ifelse(etat_suivi == "Suivi futur" &  -->

<!--                       follow_up_date <= todays_date,  -->

<!--                     NA_integer_,  -->

<!--                     n)) %>%  -->

<!--   mutate(n = ifelse(etat_suivi %in% c("Followed", "Not followed") &  -->

<!--                       follow_up_date > todays_date,  -->

<!--                     NA_integer_,  -->

<!--                     n)) %>%  -->

<!--   mutate(prop = n/sum(n)) %>%  -->

<!--   mutate(hc_ttip = glue("{format.Date(follow_up_date,  format = '%a %b %d, \\'%y')} -->

<!--                         <b>Contacts {str_to_lower(etat_suivi)}:</b> {n} -->

<!--                         ")) %>%  -->

<!--   inner_join(legend_df, by = c("etat_suivi" = "breaks")) %>%  -->

<!--   arrange(etat_suivi)   # arranging is necessary so that that colors are pulled in the right order for highcharter -->

<!-- map(unique(data_to_plot$prefecture), function(x){ -->

<!--   data_to_plot %>%  -->

<!--     filter(prefecture == x) %>%  -->

<!--     hchart("areaspline", hcaes(x = follow_up_date, y = n, -->

<!--                               group = etat_suivi), -->

<!--           fillOpacity = 0.35) %>% -->

<!--     hc_plotOptions(areaspline = list(series = list(fillOpacity = 0.1), -->

<!--                                     states = list(inactive = list(opacity = 0.4)) )) %>%  -->

<!--     hc_title(text = x) %>%  -->

<!--     hc_xAxis(title = list(text = "Date"), -->

<!--              min = min(data_to_plot$follow_up_date, na.rm = T)  %>% datetime_to_timestamp(),  -->

<!--              max = max(data_to_plot$follow_up_date, na.rm = T) %>% datetime_to_timestamp() -->

<!--              ) %>%  -->

<!--     hc_yAxis(title = list(text = "n"), -->

<!--              min = min(data_to_plot$n, na.rm = T),  -->

<!--              max = max(data_to_plot$n, na.rm = T)) %>%  -->

<!--     hc_colors(unique(data_to_plot$colors)) %>%  -->

<!--     hc_plotOptions(areaspline = list(series = list(fillOpacity = 0.1), -->

<!--                                      marker = list(enabled = TRUE, radius = 2), -->

<!--                                      states = list(inactive = list(opacity = 0.4)))) %>%  -->

<!--     hc_tooltip(formatter = JS("function(){return(this.point.hc_ttip)}"))  -->

<!--   }) %>%  -->

<!--   hw_grid(rowheight = 300, browsable = T) -->

<!-- ``` -->

<!-- # Daily count of active contacts -->

<!-- ## National-level count of active contacts with table -->

<!-- Here, the contact tracer can get an overview of how many active contacts exist currently in each region, and what the breakdown is for these contacts -->

<!-- Below we have a plot with absolute values: -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(prefecture) %>%  -->

<!--   ungroup() %>%  -->

<!--   arrange(prefecture, follow_up_date) %>%  -->

<!--   bind_rows(tibble(follow_up_date =  seq.Date(from = min(.$follow_up_date),  -->

<!--                                               to = max(.$follow_up_date),  -->

<!--                                               by = "day"),  -->

<!--                    prefecture = "temporary" -->

<!--                    )) %>%  -->

<!--   complete(follow_up_date, prefecture, fill = list(n = 0)) %>%  -->

<!--   filter(prefecture != "temporary") %>%  -->

<!--   ungroup() %>%  -->

<!--    # region with the most cases should be at the top -->

<!--   group_by(prefecture) %>%  -->

<!--   mutate(total = sum(n)) %>%  -->

<!--   ungroup() %>%  -->

<!--   mutate(prefecture = fct_rev(fct_reorder(prefecture, total))) -->

<!-- data_to_plot %>%  -->

<!--   hchart("column", hcaes(x = follow_up_date, y = n, group = prefecture)) %>%  -->

<!--   hc_yAxis(visible = TRUE) %>%  -->

<!--   hc_plotOptions(column = list(stacking = "normal",  -->

<!--                                pointPadding = 0,  -->

<!--                                groupPadding = 0,  -->

<!--                                borderWidth= 0.05, -->

<!--                                stickyTracking = T -->

<!--                                )) %>%  -->

<!--   hc_plotOptions(column = list(states = list(inactive = list(opacity = 0.7)))) %>%  -->

<!--   hc_xAxis(title = list(text = "Date")) %>%  -->

<!--   hc_yAxis(title = list(text = "Daily Number of active contacts")) %>%  -->

<!--   hc_exporting(enabled = TRUE) -->

<!-- ``` -->

<!-- And here we have a plot with relative proportions: -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   select( -->

<!--     row_id, -->

<!--     name_last_contact, -->

<!--     name_first_contact, -->

<!--     date_last_interaction, -->

<!--     follow_up_day, -->

<!--     follow_up_date, -->

<!--     etat_suivi,  -->

<!--     prefecture -->

<!--   ) %>%  -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(prefecture) %>%  -->

<!--   group_by(follow_up_date) %>%  -->

<!--   mutate(prop = n/sum(n)) %>%  -->

<!--   ungroup() %>%  -->

<!--   arrange(prefecture, follow_up_date) %>%  -->

<!--   bind_rows(tibble(follow_up_date =  seq.Date(from = min(.$follow_up_date),  -->

<!--                                               to = max(.$follow_up_date),  -->

<!--                                               by = "day"),  -->

<!--                    prefecture = "temporary" -->

<!--                    )) %>%  -->

<!--   complete(follow_up_date, prefecture, fill = list(n = 0, prop = 0)) %>%  -->

<!--   filter(prefecture != "temporary") %>%  -->

<!--   ungroup() %>%  -->

<!--   # region with the most cases should be at the top -->

<!--   group_by(prefecture) %>%  -->

<!--   mutate(total = sum(n)) %>%  -->

<!--   ungroup() %>%  -->

<!--   mutate(prefecture = fct_rev(fct_reorder(prefecture, total))) -->

<!-- data_to_plot %>%  -->

<!--   hchart("column", hcaes(x = follow_up_date, y = prop, group = prefecture)) %>%  -->

<!--   hc_yAxis(visible = TRUE) %>%  -->

<!--   hc_plotOptions(column = list(stacking = "normal",  -->

<!--                                pointPadding = 0,  -->

<!--                                groupPadding = 0,  -->

<!--                                borderWidth= 0.05, -->

<!--                                stickyTracking = T -->

<!--                                )) %>%  -->

<!--   hc_plotOptions(column = list(states = list(inactive = list(opacity = 0.7)))) %>%  -->

<!--   hc_xAxis(title = list(text = "Date")) %>%  -->

<!--   hc_yAxis(title = list(text = "Daily Number of active contacts")) %>%  -->

<!--   hc_exporting(enabled = TRUE) -->

<!-- ``` -->

<!-- ## Regional-level daily count of active contacts -->

<!-- Here the contact tracer can see the current and historical breakdown of active cases for the level 2 administrative divisions within each level 1 division. -->

<!-- Here we have plots of absolute values: -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   select( -->

<!--     row_id, -->

<!--     name_last_contact, -->

<!--     name_first_contact, -->

<!--     date_last_interaction, -->

<!--     follow_up_day, -->

<!--     follow_up_date, -->

<!--     etat_suivi,  -->

<!--     prefecture,  -->

<!--     sous_prefecture -->

<!--   ) %>%  -->

<!--   filter(follow_up_day == 1) %>%  -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(prefecture, sous_prefecture) %>%  -->

<!--   ungroup() %>%  -->

<!--   bind_rows(tibble(follow_up_date =  seq.Date(from = min(.$follow_up_date),  -->

<!--                                               to = max(.$follow_up_date),  -->

<!--                                               by = "day"),  -->

<!--                    prefecture = "temporary", -->

<!--                    sous_prefecture = "temporary" -->

<!--                    )) %>%  -->

<!--   complete(follow_up_date, prefecture, fill = list(n = 0)) %>%  -->

<!--   filter(prefecture != "temporary" & !is.na(prefecture)) %>%  -->

<!--   group_by(prefecture) %>%  -->

<!--   complete(follow_up_date, sous_prefecture, fill = list(n = 0)) %>% -->

<!--   ungroup() %>%  -->

<!--   filter(sous_prefecture != "temporary" & !is.na(sous_prefecture)) %>%  -->

<!--   arrange(prefecture, sous_prefecture, follow_up_date) -->

<!-- map(unique(data_to_plot$prefecture), function(x){ -->

<!--   data_to_plot %>%  -->

<!--     filter(prefecture == x) %>%  -->

<!--     # region with the most cases should be at the top -->

<!--     group_by(sous_prefecture) %>%  -->

<!--     mutate(total = sum(n)) %>%  -->

<!--     ungroup() %>%  -->

<!--     mutate(sous_prefecture = fct_rev(fct_reorder(sous_prefecture, total))) %>%  -->

<!--     hchart("column", hcaes(x = follow_up_date, y = n, group = sous_prefecture)) %>%  -->

<!--     hc_title(text = x) %>%  -->

<!--     hc_yAxis(visible = TRUE) %>%  -->

<!--     hc_plotOptions(column = list(stacking = "normal",  -->

<!--                                  pointPadding = 0,  -->

<!--                                  groupPadding = 0,  -->

<!--                                  borderWidth= 0.05, -->

<!--                                  stickyTracking = T -->

<!--                                  )) %>%  -->

<!--     hc_plotOptions(column = list(states = list(inactive = list(opacity = 0.7)))) %>%  -->

<!--     hc_xAxis(title = list(text = "Date")) %>%  -->

<!--     hc_yAxis(title = list(text = "Daily Number of active contacts")) %>%  -->

<!--     hc_exporting(enabled = TRUE) %>%  -->

<!--     hc_xAxis(title = list(text = "Date"), -->

<!--              min = min(data_to_plot$follow_up_date, na.rm = T)  %>% datetime_to_timestamp(),  -->

<!--              max = max(data_to_plot$follow_up_date, na.rm = T) %>% datetime_to_timestamp() -->

<!--              ) %>%  -->

<!--     hc_yAxis(title = list(text = "n"), -->

<!--              min = min(data_to_plot$n, na.rm = T),  -->

<!--              max = max(data_to_plot$n, na.rm = T))  -->

<!--   }) %>%  -->

<!--   hw_grid(rowheight = 300, ncol = 2, browsable = T) -->

<!-- ``` -->

<!-- And here we have plots of relative proportions: -->

<!-- ```{r} -->

<!-- data_to_plot <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   select( -->

<!--     row_id, -->

<!--     name_last_contact, -->

<!--     name_first_contact, -->

<!--     date_last_interaction, -->

<!--     follow_up_day, -->

<!--     follow_up_date, -->

<!--     etat_suivi,  -->

<!--     prefecture,  -->

<!--     sous_prefecture -->

<!--   ) %>%  -->

<!--   filter(follow_up_day == 1) %>%  -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(prefecture, sous_prefecture) %>%  -->

<!--   ungroup() %>%  -->

<!--   bind_rows(tibble(follow_up_date =  seq.Date(from = min(.$follow_up_date),  -->

<!--                                               to = max(.$follow_up_date),  -->

<!--                                               by = "day"),  -->

<!--                    prefecture = "temporary", -->

<!--                    sous_prefecture = "temporary" -->

<!--                    )) %>%  -->

<!--   complete(follow_up_date, prefecture, fill = list(n = 0)) %>%  -->

<!--   filter(prefecture != "temporary" & !is.na(prefecture)) %>%  -->

<!--   group_by(prefecture) %>%  -->

<!--   complete(follow_up_date, sous_prefecture, fill = list(n = 0)) %>% -->

<!--   filter(sous_prefecture != "temporary" & !is.na(sous_prefecture)) %>%  -->

<!--   group_by(prefecture, follow_up_date) %>%  -->

<!--   mutate(prop = n/sum(n)) %>%  -->

<!--   ungroup() %>%  -->

<!--   arrange(prefecture, sous_prefecture, follow_up_date) -->

<!-- map(unique(data_to_plot$prefecture), function(x){ -->

<!--   data_to_plot %>%  -->

<!--     filter(prefecture == x) %>%  -->

<!--     # region with the most cases should be at the top -->

<!--     group_by(sous_prefecture) %>%  -->

<!--     mutate(sous_prefecture_total = sum(n)) %>%  -->

<!--     ungroup() %>%  -->

<!--     mutate(sous_prefecture = fct_rev(fct_reorder(sous_prefecture, sous_prefecture_total))) %>%  -->

<!--     hchart("column", hcaes(x = follow_up_date, y = prop, group = sous_prefecture)) %>%  -->

<!--     hc_title(text = x) %>%  -->

<!--     hc_yAxis(visible = TRUE) %>%  -->

<!--     hc_plotOptions(column = list(stacking = "normal",  -->

<!--                                  pointPadding = 0,  -->

<!--                                  groupPadding = 0,  -->

<!--                                  borderWidth= 0.05, -->

<!--                                  stickyTracking = T -->

<!--                                  )) %>%  -->

<!--     hc_plotOptions(column = list(states = list(inactive = list(opacity = 0.7)))) %>%  -->

<!--     hc_xAxis(title = list(text = "Date")) %>%  -->

<!--     hc_yAxis(title = list(text = "Daily Number of active contacts")) %>%  -->

<!--     hc_exporting(enabled = TRUE) %>%  -->

<!--     hc_xAxis(title = list(text = "Date"), -->

<!--              min = min(data_to_plot$follow_up_date, na.rm = T)  %>% datetime_to_timestamp(),  -->

<!--              max = max(data_to_plot$follow_up_date, na.rm = T) %>% datetime_to_timestamp() -->

<!--              ) %>%  -->

<!--     hc_yAxis(title = list(text = "n"), -->

<!--              min = min(data_to_plot$prop, na.rm = T),  -->

<!--              max = max(data_to_plot$prop, na.rm = T))  -->

<!--   }) %>%  -->

<!--   hw_grid(rowheight = 300, ncol = 2, browsable = T) -->

<!-- ``` -->

<!-- ## Active contacts per region on each day -->

<!-- ## Cumulative contacts per region -->

<!-- ```{r} -->

<!-- contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>% -->

<!--   select( -->

<!--     row_id, -->

<!--     name_last_contact, -->

<!--     name_first_contact, -->

<!--     date_last_interaction, -->

<!--     follow_up_day, -->

<!--     follow_up_date, -->

<!--     etat_suivi,  -->

<!--     prefecture -->

<!--   ) %>%  -->

<!--   filter(follow_up_day == 1) %>%  -->

<!--   group_by(follow_up_date, prefecture) %>%  -->

<!--   count(prefecture) %>%  -->

<!--   ungroup() %>%  -->

<!--   arrange(prefecture, follow_up_date) %>%  -->

<!--   bind_rows(tibble(follow_up_date =  seq.Date(from = min(.$follow_up_date),  -->

<!--                                               to = max(.$follow_up_date),  -->

<!--                                               by = "day"),  -->

<!--                    prefecture = "temporary" -->

<!--                    )) %>%  -->

<!--   complete(follow_up_date, prefecture, fill = list(n = 0)) %>%  -->

<!--   filter(prefecture != "temporary") %>%  -->

<!--   group_by(prefecture) %>%  -->

<!--   mutate(cum_n = cumsum(n)) %>%  -->

<!--   ungroup() %>%  -->

<!--   hchart("column", hcaes(x = follow_up_date, y = cum_n, group = prefecture)) %>%  -->

<!--   hc_yAxis(visible = TRUE) %>%  -->

<!--   hc_plotOptions(column = list(stacking = "normal",  -->

<!--                                pointPadding = 0,  -->

<!--                                groupPadding = 0,  -->

<!--                                borderWidth= 0, -->

<!--                                stickyTracking = T -->

<!--                                )) %>%  -->

<!--   hc_plotOptions(column = list(states = list(inactive = list(opacity = 0.7)))) %>%  -->

<!--   hc_xAxis(title = list(text = "Date")) %>%  -->

<!--   hc_yAxis(title = list(text = "Cumulative Number of contacts")) -->

<!-- ``` -->

<!-- ## Distribution of Active Contacts by Sex  -->

<!-- ```{r} -->

<!-- x <- c("Sex: ", "Count: ") -->

<!-- y <- c("{point.sex_contact}", "{point.n}") -->

<!-- tltip <- tooltip_table(x, y) -->

<!-- contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>%  -->

<!--   filter(follow_up_day == 14) %>%  -->

<!--   filter(follow_up_date >= todays_date) %>%  -->

<!--   mutate(sex_contact = str_to_upper(sex_contact)) %>%  -->

<!--   mutate(sex_contact = ifelse(sex_contact %in% c("F", "M"), sex_contact, "Missing" )) %>%  -->

<!--   count(sex_contact) %>%  -->

<!--   hchart("pie", hcaes(name = sex_contact, y = n ),  -->

<!--          innerSize = "40%",  -->

<!--          showInLegend = TRUE,  -->

<!--          dataLabels = list(enabled = FALSE)) %>%  -->

<!--   hc_title(text= 'Breakdown of active contacts by sex') %>%  -->

<!--   hc_tooltip(useHTML = TRUE, -->

<!--              headerFormat = "",  -->

<!--              pointFormat = tltip)  -->

<!-- ``` -->

<!-- ## Distribution of Contacts by Contact Type Sunburst  -->

<!-- ```{r} -->

<!-- contact_types <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>%  -->

<!--   filter(follow_up_day == 14) %>%  -->

<!--   filter(follow_up_date >= todays_date) %>%  -->

<!--   select(type_contact, relation_contact_case) %>%  -->

<!--   mutate(across(.fns =  -->

<!--                 ~.x %>%  -->

<!--                   str_to_lower() %>%  -->

<!--                   str_to_title() %>%  -->

<!--                   replace_na("NA") %>%  -->

<!--                   str_replace_all(" \\s*\\([^\\)]+\\)", "") %>%  -->

<!--                   str_trim())) %>%  -->

<!--   add_count(type_contact, name = "n_type_contact") %>%  -->

<!--   mutate(pct_type_contact = round( 100 * n_type_contact/nrow(.), digits = 1 )) %>%  -->

<!--   group_by(type_contact) %>%  -->

<!--   mutate(relation_contact_case = fct_lump(other_level = "Autres", relation_contact_case, prop = 0.01)) %>%  -->

<!--   add_count(relation_contact_case, name = "n_relation_contact_case") %>%  -->

<!--   mutate(pct_relation_contact_case = round( 100 * n_relation_contact_case/nrow(.), digits = 1 )) %>%  -->

<!--   group_by(type_contact, relation_contact_case) %>%  -->

<!--   slice_head(n = 1) %>%  -->

<!--   ungroup() %>%  -->

<!--   mutate(type_contact = paste0(type_contact, " (", pct_type_contact, "%", ")")) %>%  -->

<!--   mutate(relation_contact_case = paste0(relation_contact_case, " (", pct_relation_contact_case, "%", ")")) %>%  -->

<!--   ungroup()  -->

<!-- full_palette <- c("#332859",(paletteer_d("awtools::a_palette") %>%  -->

<!--                                      as.character() %>% -->

<!--                                      str_sub(1,7) -->

<!--                                    ) -->

<!--                         ) -->

<!-- color_df <-  -->

<!--   data.frame(type_contact = levels(as.factor(contact_types$type_contact))) %>%  -->

<!--   add_column(color_lvl_1 = c(russian_violet, cinnabar)) -->

<!-- contact_types_list <-  -->

<!--   contact_types %>%  -->

<!--   data_to_hierarchical(group_vars = c(type_contact, relation_contact_case), size_var = n_relation_contact_case,  -->

<!--                        colors = c(russian_violet, cinnabar)) -->

<!-- x <- c("Type: ", "n = ") -->

<!-- y <- c("{point.name}", "{point.value}") -->

<!-- tltip <- tooltip_table(x, y) -->

<!-- highchart() %>%  -->

<!--   hc_chart(type = "sunburst") %>%  -->

<!--   hc_title(text = "Breakdown of contacts by contact type") %>%  -->

<!--   #hc_subtitle(text = subtitle, useHTML = TRUE) %>%  -->

<!--   hc_add_series(data = contact_types_list, -->

<!--                 allowDrillToNode = TRUE, -->

<!--                 levelIsConstant = FALSE, -->

<!--                 #textOverflow = "clip", -->

<!--                 levels = list(list(level = 1, -->

<!--                                    borderWidth = 1,  -->

<!--                                    dataLabels = list(enabled = TRUE, -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "14px", -->

<!--                                                                   #fontWeight = "bold", -->

<!--                                                                   #textOutline = "white",  -->

<!--                                                                   opacity = 0.8))),  -->

<!--                               list(level = 2,  -->

<!--                                    borderWidth = 0, -->

<!--                                    dataLabels = list(enabled = TRUE,  -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "12px",  -->

<!--                                                                   textOutline = FALSE,  -->

<!--                                                                   opacity = 0.8))),  -->

<!--                               list(level = 3, -->

<!--                                    borderWidth = 0, -->

<!--                                    dataLabels = list(enabled = TRUE,  -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "8px",  -->

<!--                                                                   textOutline = FALSE,  -->

<!--                                                                   opacity = 0.8))))) %>%  -->

<!--   hc_plotOptions(sunburst = list(dataLabels = list(enabled = TRUE) )) %>%  -->

<!--   hc_tooltip(useHTML = TRUE, -->

<!--                headerFormat = "",  -->

<!--                pointFormat = tltip)  -->

<!-- ``` -->

<!-- ## Distribution of Contacts by Region -->

<!-- ```{r} -->

<!-- contact_regions <-  -->

<!--   contacts_df_long %>% -->

<!--   # filter(max(follow_up_date, na.rm = T) > todays_date) %>% -->

<!--   inner_join(contacts_df,  -->

<!--              by = "row_id" -->

<!--              ) %>%  -->

<!--   filter(follow_up_day == 14) %>%  -->

<!--   filter(follow_up_date >= todays_date) %>%  -->

<!--   select(prefecture, sous_prefecture, quartier) %>%  -->

<!--   mutate(across(.fns =  -->

<!--                  ~.x %>%  -->

<!--                  str_to_lower() %>%  -->

<!--                  str_to_title() %>%  -->

<!--                  replace_na("NA") %>%  -->

<!--                  str_trim())) %>%  -->

<!--   add_count(prefecture, name = "n_prefecture") %>%  -->

<!--   mutate(pct_prefecture = round( 100 * n_prefecture/nrow(.), digits = 2 )) %>%  -->

<!--   mutate(prefecture = paste0(prefecture, " (", pct_prefecture, "%", ")")) %>%  -->

<!--   group_by(prefecture) %>%  -->

<!--   mutate(sous_prefecture = fct_lump(other_level = "Autres", sous_prefecture, prop = 0.01)) %>%  -->

<!--   add_count(sous_prefecture, name = "n_sous_prefecture") %>%  -->

<!--   mutate(pct_sous_prefecture = round( 100 * n_sous_prefecture/nrow(.), digits = 2 )) %>%  -->

<!--   mutate(sous_prefecture = paste0(sous_prefecture, " (", pct_sous_prefecture, "%", ")")) %>%  -->

<!--   group_by(prefecture, sous_prefecture) %>%  -->

<!--   mutate(quartier = fct_lump(other_level = "Autres", quartier, prop = 0.02)) %>%  -->

<!--   add_count(quartier, name = "n_quartier") %>% -->

<!--   mutate(pct_quartier = round( 100 * n_quartier/nrow(.), digits = 2 )) %>% -->

<!--   mutate(quartier = paste0(quartier, " (", pct_quartier, "%", ")")) %>% -->

<!--   group_by(prefecture, sous_prefecture, quartier) %>%  -->

<!--   slice_head(n = 1) %>%  -->

<!--   ungroup() %>%  -->

<!--   arrange(-n_prefecture) -->

<!-- full_palette <-  -->

<!--   c(russian_violet, cinnabar, -->

<!--     "#56bfa3", "#f79f57" ,"#7570B3","#56B4E9", #greenblue #lightorange #purplepastel #lightblue -->

<!--     "#3758a6" , "#CC79A7" , "#91142c", "#63a88a", #darkblue #pinkpurple #wine #pastelgreen -->

<!--     "#a3b0c4", "#870476", "#479444", "#3cd6d6" ) # grey, # royalpurple #darkgreen # cyan  -->

<!-- color_df <-  -->

<!--   data.frame(prefecture = unique(contact_regions$prefecture)) %>%  -->

<!--   add_column(color_lvl_1 = full_palette[1:nrow(.)]) -->

<!-- contact_regions_list <-  -->

<!--   contact_regions %>%  -->

<!--   data_to_hierarchical(group_vars = c(prefecture,  -->

<!--                                       sous_prefecture,  -->

<!--                                       quartier -->

<!--                                       ),  -->

<!--                        size_var = n_quartier,  -->

<!--                        colors= color_df$color_lvl_1) -->

<!-- x <- c("Type: ", "n = ") -->

<!-- y <- c("{point.name}", "{point.value}") -->

<!-- tltip <- tooltip_table(x, y) -->

<!-- highchart() %>%  -->

<!--   hc_chart(type = "sunburst") %>%  -->

<!--   hc_title(text = "Breakdown of contacts by Region ") %>%  -->

<!--   #hc_subtitle(text = subtitle, useHTML = TRUE) %>%  -->

<!--   hc_add_series(data = contact_regions_list, -->

<!--                 allowDrillToNode = TRUE, -->

<!--                 levelIsConstant = FALSE, -->

<!--                 #textOverflow = "clip", -->

<!--                 levels = list(list(level = 1, -->

<!--                                    borderWidth = 1,  -->

<!--                                    dataLabels = list(enabled = TRUE, -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "14px", -->

<!--                                                                   #fontWeight = "bold", -->

<!--                                                                   #textOutline = "white",  -->

<!--                                                                   opacity = 0.8))),  -->

<!--                               list(level = 2,  -->

<!--                                    borderWidth = 0, -->

<!--                                    dataLabels = list(enabled = TRUE,  -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "12px",  -->

<!--                                                                   textOutline = FALSE,  -->

<!--                                                                   opacity = 0.8))),  -->

<!--                               list(level = 3, -->

<!--                                    borderWidth = 0, -->

<!--                                    dataLabels = list(enabled = TRUE,  -->

<!--                                                      color = "#FFFFFF", -->

<!--                                                      style = list(fontSize = "8px",  -->

<!--                                                                   textOutline = FALSE,  -->

<!--                                                                   opacity = 0.8))))) %>%  -->

<!--   hc_plotOptions(sunburst = list(dataLabels = list(enabled = TRUE) )) %>%  -->

<!--   hc_size(600, 600) %>%  -->

<!--  hc_tooltip(useHTML = TRUE,  -->

<!--             headerFormat = "", pointFormat = tltip)  -->

<!-- ``` -->
